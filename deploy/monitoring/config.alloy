constants {
  hostname = "lily-salon-vps"
  // Имя проекта из Docker Compose (берется из переменной окружения)
  project_name = sys.env("COMPOSE_PROJECT_NAME")
}

// --- LOGS (Loki) ---

discovery.docker "linux_containers" {
  host = "unix:///var/run/docker.sock"
  refresh_interval = "15s"
}

loki.source.docker "docker_logs" {
  nodes = discovery.docker.linux_containers.targets
  client = loki.write.grafana_loki.receiver

  forward_to = [loki.write.grafana_loki.receiver]
}

loki.write "grafana_loki" {
  endpoint {
    url = sys.env("GCLOUD_HOSTED_LOGS_URL")
    basic_auth {
      username = sys.env("GCLOUD_HOSTED_LOGS_ID")
      password = sys.env("GCLOUD_RW_API_KEY")
    }
  }
}

// --- METRICS (Prometheus) ---

prometheus.exporter.unix "node_exporter" { }

prometheus.scrape "node_metrics" {
  targets    = prometheus.exporter.unix.node_exporter.targets
  forward_to = [prometheus.remote_write.grafana_cloud.receiver]
}

prometheus.remote_write "grafana_cloud" {
  endpoint {
    url = sys.env("GCLOUD_HOSTED_METRICS_URL")
    basic_auth {
      username = sys.env("GCLOUD_HOSTED_METRICS_ID")
      password = sys.env("GCLOUD_RW_API_KEY")
    }
  }
}
